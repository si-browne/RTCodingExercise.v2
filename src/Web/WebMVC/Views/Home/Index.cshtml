@model RTCodingExercise.Microservices.Models.PagedResult<RTCodingExercise.Microservices.Models.Plate>

@{
    ViewData["Title"] = "Regtransfers Plate Shop";
    var stats = ViewBag.Statistics as RTCodingExercise.Microservices.Models.RevenueStatistics;
}

<style>
    @@font-face {
        font-family: 'UKNumberPlate';
        src: url('https://cdn.jsdelivr.net/gh/petemill/uk-number-plate-font@master/UKNumberPlate.woff2') format('woff2'),
             url('https://cdn.jsdelivr.net/gh/petemill/uk-number-plate-font@master/UKNumberPlate.woff') format('woff');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }
</style>

<h1 class="mb-4">Regtransfers Plate Shop</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Revenue Statistics Dashboard (User Story 6) -->
@if (stats != null)
{
    <div class="row mb-4">
        <!-- Statistics Cards Column -->
        <div class="col-md-4">
            <div class="row g-3">
                <div class="col-12">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Revenue</h5>
                            <p class="card-text display-6">£@stats.TotalRevenue.ToString("N2")</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Profit</h5>
                            <p class="card-text display-6">£@stats.TotalProfit.ToString("N2")</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Plates Sold</h5>
                            <p class="card-text display-6">@stats.PlatesSold</p>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title">Avg Profit Margin</h5>
                            <p class="card-text display-6">@stats.AverageProfitMargin.ToString("P2")</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profit Margin Chart Column (User Story 6 Advanced) -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Profit Margin Analytics</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="profitMarginChart" style="max-width: 400px; max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>
}

<!-- Search and Filter Form (User Stories 2-5) -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" asp-action="Index">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="search" class="form-label">Search Registration</label>
                    <input type="text" class="form-control" id="search" name="search" value="@ViewBag.Search" placeholder="e.g., AB12">
                </div>
                <div class="col-md-2">
                    <label for="letters" class="form-label">Letters</label>
                    <input type="text" class="form-control" id="letters" name="letters" value="@ViewBag.Letters" placeholder="e.g., ABC">
                </div>
                <div class="col-md-2">
                    <label for="numbers" class="form-label">Numbers</label>
                    <input type="number" class="form-control" id="numbers" name="numbers" value="@ViewBag.Numbers" placeholder="e.g., 123">
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="0" selected="@(ViewBag.Status == RTCodingExercise.Microservices.Models.PlateStatus.ForSale)">For Sale</option>
                        <option value="1" selected="@(ViewBag.Status == RTCodingExercise.Microservices.Models.PlateStatus.Reserved)">Reserved</option>
                        <option value="2" selected="@(ViewBag.Status == RTCodingExercise.Microservices.Models.PlateStatus.Sold)">Sold</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy" name="sortBy">
                        <option value="">Default</option>
                        <option value="price_asc" selected="@(ViewBag.SortBy == "price_asc")">Price: Low to High</option>
                        <option value="price_desc" selected="@(ViewBag.SortBy == "price_desc")">Price: High to Low</option>
                        <option value="registration_asc" selected="@(ViewBag.SortBy == "registration_asc")">Registration: A-Z</option>
                        <option value="registration_desc" selected="@(ViewBag.SortBy == "registration_desc")">Registration: Z-A</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Search</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Plates Grid (User Stories 1-5) -->
@if (Model != null && Model.Items.Any())
{
    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4 mb-4">
        @foreach (var plate in Model.Items)
        {
            <div class="col">
                <div class="card h-100">
                    <!-- UK-style number plate design -->
                    <div class="card-body text-center p-0">
                        <div style="background-color: #ffd900; border: 4px solid #000; border-radius: 4px; padding: 15px 10px; margin: 15px;">
                            <div style="font-family: 'UKNumberPlate', 'Charles Wright', Arial, sans-serif; font-size: 1.5rem; font-weight: bold; letter-spacing: 8px; color: #000; text-shadow: 1px 1px 0px rgba(0,0,0,0.1);">
                                @PlateHelpers.FormatRegistration(plate.Registration)
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Sale Price:</strong> £@plate.SalePrice.ToString("N2")</p>
                        <p class="mb-1"><strong>Status:</strong> 
                            @if (plate.Status == RTCodingExercise.Microservices.Models.PlateStatus.ForSale)
                            {
                                <span class="badge bg-success">For Sale</span>
                            }
                            else if (plate.Status == RTCodingExercise.Microservices.Models.PlateStatus.Reserved)
                            {
                                <span class="badge bg-warning text-dark">Reserved</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Sold</span>
                            }
                        </p>
                        
                        @if (plate.Status == RTCodingExercise.Microservices.Models.PlateStatus.ForSale)
                        {
                            <div class="mt-2">
                                <form method="post" asp-action="Reserve" asp-route-id="@plate.Id" class="mb-1">
                                    <button type="submit" class="btn btn-sm btn-primary w-100">Reserve</button>
                                </form>
                                <button type="button" class="btn btn-sm btn-success w-100" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#sellModal"
                                        data-plate-id="@plate.Id"
                                        data-plate-registration="@plate.Registration"
                                        data-plate-price="@plate.SalePrice">
                                    Sell
                                </button>
                            </div>
                        }
                        else if (plate.Status == RTCodingExercise.Microservices.Models.PlateStatus.Reserved)
                        {
                            <div class="mt-2">
                                <form method="post" asp-action="Unreserve" asp-route-id="@plate.Id" class="mb-1">
                                    <button type="submit" class="btn btn-sm btn-secondary w-100">Unreserve</button>
                                </form>
                                <button type="button" class="btn btn-sm btn-success w-100" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#sellModal"
                                        data-plate-id="@plate.Id"
                                        data-plate-registration="@plate.Registration"
                                        data-plate-price="@plate.SalePrice">
                                    Sell
                                </button>
                            </div>
                        }
                        else
                        {
                            <p class="mb-1 mt-2"><small><strong>Sold Price:</strong> £@plate.SoldPrice?.ToString("N2")</small></p>
                            @if (!string.IsNullOrEmpty(plate.PromoCodeUsed))
                            {
                                <p class="mb-1"><small><strong>Promo:</strong> @plate.PromoCodeUsed</small></p>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Pagination (User Story 3 - 20 per page) -->
    @if (Model.TotalPages > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                @if (Model.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { 
                            search = ViewBag.Search, 
                            letters = ViewBag.Letters, 
                            numbers = ViewBag.Numbers,
                            status = ViewBag.Status,
                            sortBy = ViewBag.SortBy,
                            page = Model.Page - 1 
                        })">Previous</a>
                    </li>
                }

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Page ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { 
                            search = ViewBag.Search, 
                            letters = ViewBag.Letters, 
                            numbers = ViewBag.Numbers,
                            status = ViewBag.Status,
                            sortBy = ViewBag.SortBy,
                            page = i 
                        })">@i</a>
                    </li>
                }

                @if (Model.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { 
                            search = ViewBag.Search, 
                            letters = ViewBag.Letters, 
                            numbers = ViewBag.Numbers,
                            status = ViewBag.Status,
                            sortBy = ViewBag.SortBy,
                            page = Model.Page + 1 
                        })">Next</a>
                    </li>
                }
            </ul>
        </nav>
    }
}
else
{
    <div class="alert alert-info">
        <p class="mb-0">No plates found matching your criteria.</p>
    </div>
}

<!-- Sell Modal (User Story 7 - Promo Code Calculator) -->
<div class="modal fade" id="sellModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sell Plate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="sellForm" method="post" asp-action="Sell">
                <div class="modal-body">
                    <input type="hidden" name="id" id="sellPlateId">
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Registration:</strong></label>
                        <p id="sellPlateRegistration" class="mb-0"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Original Price:</strong></label>
                        <p id="sellPlateOriginalPrice" class="mb-0"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="promoCode" class="form-label">Promo Code (Optional)</label>
                        <select class="form-select" id="promoCode" name="promoCode">
                            <option value="">No Discount</option>
                            <option value="DISCOUNT">DISCOUNT (£25 off)</option>
                            <option value="PERCENTOFF">PERCENTOFF (15% off)</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Final Price:</strong> <span id="finalPrice">£0.00</span>
                    </div>
                    
                    <div id="priceError" class="alert alert-danger d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Confirm Sale</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js CDN - Load first -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        // Sell Modal Handler
        const sellModal = document.getElementById('sellModal');
        let currentPlateId = null;
        let currentOriginalPrice = 0;

        sellModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            currentPlateId = button.getAttribute('data-plate-id');
            const registration = button.getAttribute('data-plate-registration');
            currentOriginalPrice = parseFloat(button.getAttribute('data-plate-price'));

            document.getElementById('sellPlateId').value = currentPlateId;
            document.getElementById('sellPlateRegistration').textContent = registration;
            document.getElementById('sellPlateOriginalPrice').textContent = '£' + currentOriginalPrice.toFixed(2);
            document.getElementById('finalPrice').textContent = '£' + currentOriginalPrice.toFixed(2);
            document.getElementById('promoCode').value = '';
            document.getElementById('priceError').classList.add('d-none');
        });

        // Price Calculator (User Story 7)
        document.getElementById('promoCode').addEventListener('change', async function() {
            const promoCode = this.value;
            
            try {
                const response = await fetch(`/Home/CalculatePrice?id=${currentPlateId}&promoCode=${promoCode}`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('finalPrice').textContent = '£' + result.price.toFixed(2);
                    document.getElementById('priceError').classList.add('d-none');
                } else {
                    document.getElementById('priceError').textContent = result.error;
                    document.getElementById('priceError').classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error calculating price:', error);
            }
        });

        // Profit Margin Chart (User Story 6 Advanced) - Chart.js
        @if (stats != null && stats.PlatesSold > 0)
        {
            <text>
            const ctx = document.getElementById('profitMarginChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Profit', 'Cost'],
                    datasets: [{
                        label: 'Profit Breakdown',
                        data: [@stats.TotalProfit.ToString("F2"), @((stats.TotalRevenue - stats.TotalProfit).ToString("F2"))],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',   // Green for profit
                            'rgba(220, 53, 69, 0.8)'    // Red for cost
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Revenue vs Profit - Average Margin: @stats.AverageProfitMargin.ToString("P2")',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = @stats.TotalRevenue.ToString("F2");
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return label + ': £' + value.toFixed(2) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            </text>
        }
    </script>
}
